<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>PHIẾU KHÁM BỆNH</title>
  <style>
    /* Giữ nguyên phần CSS như trước */
    body {
      font-family: 'Arial', serif;
      margin: 0;
      padding: 20px;
      font-size: 12pt;
    }
    /* ... (giữ nguyên toàn bộ CSS hiện có) ... */
  </style>
</head>
<body>
  <!-- Giữ nguyên phần header HTML như trước -->
  <div style="text-align: center; font-family: 'Arial', serif; margin-bottom: 20px;">
    <!-- ... (giữ nguyên phần header hiện có) ... -->
  </div>

  <!-- Phần thông tin bệnh nhân (giữ nguyên) -->
  <div class="patient-info">
    <!-- ... (giữ nguyên các trường thông tin hiện có) ... -->
  </div>

  <!-- Phần đơn thuốc (sẽ được điền bằng JavaScript) -->
  <div class="info-label">Đơn thuốc:</div>
  <table id="donthuoc-table">
    <thead>
      <tr>
        <th width="5%">STT</th>
        <th width="30%">Tên thuốc</th>
        <th width="10%">ĐVT</th>
        <th width="10%">Số lượng</th>
        <th width="45%">Cách sử dụng</th>
      </tr>
    </thead>
    <tbody>
      <!-- Sẽ được điền bằng JavaScript -->
    </tbody>
  </table>
  
  <!-- Phần thủ thuật (sẽ được điền bằng JavaScript) -->
  <div class="info-label">Thủ thuật:</div>
  <table id="thuthuat-table">
    <tbody>
      <!-- Sẽ được điền bằng JavaScript -->
    </tbody>
  </table>

  <!-- Phần chân trang (giữ nguyên) -->
  <div class="doctor-sign">
    <!-- ... -->
  </div>

  <!-- Thêm đoạn script xử lý dữ liệu -->
  <script>
  function getUrlParameter(name) {
    name = name.replace(/[\[\]]/g, '\\$&');
    const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
    const results = regex.exec(window.location.href);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  function parseJsonOrArray(param) {
    try {
      // Thử parse JSON
      return JSON.parse(param);
    } catch (e) {
      // Nếu không phải JSON, xử lý như mảng đơn giản
      if (param && param.includes(',')) {
        return param.split(',').map(item => ({value: item.trim()}));
      }
      return [];
    }
  }

  function displayData() {
    // Hiển thị thông tin cơ bản
    document.getElementById('hoten').textContent = getUrlParameter('hoten') || '';
    // ... (các trường thông tin khác giữ nguyên) ...

    // Xử lý đơn thuốc
    const donthuocParam = getUrlParameter('donthuoc');
    if (donthuocParam) {
      const donthuoc = parseJsonOrArray(donthuocParam);
      const tbody = document.querySelector('#donthuoc-table tbody');
      tbody.innerHTML = '';
      
      if (donthuoc.length > 0) {
        donthuoc.forEach((item, index) => {
          const row = document.createElement('tr');
          // Xử lý cả dạng JSON object và mảng đơn giản
          const tenThuoc = item.tenThuoc || item.Tenthuoc || item.value || '';
          const dvt = item.dvt || item.DVT || '';
          const soLuong = item.soLuong || item.Soluong || '';
          const cachDung = item.cachDung || item.Cachdung || '';
          
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${tenThuoc}</td>
            <td>${dvt}</td>
            <td>${soLuong}</td>
            <td>${cachDung}</td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    // Xử lý thủ thuật
    const thuthuatParam = getUrlParameter('thuthuat');
    if (thuthuatParam) {
      const thuthuat = parseJsonOrArray(thuthuatParam);
      const tbody = document.querySelector('#thuthuat-table tbody');
      tbody.innerHTML = '';
      
      if (thuthuat.length > 0) {
        thuthuat.forEach((item, index) => {
          const row = document.createElement('tr');
          const tenThuThu = item.tenThuThu || item.Tenthuthuat || item.value || '';
          const ghiChu = item.ghiChu || item.Ghichu || '';
          
          row.innerHTML = `
            <td>${tenThuThu}</td>
            <td>${ghiChu}</td>
          `;
          tbody.appendChild(row);
        });
      }
    }

    // Tự động in
    if (getUrlParameter('autoprint') === '1') {
      setTimeout(() => { window.print(); }, 500);
    }
  }

  window.onload = displayData;
  </script>
</body>
</html>
