<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>PHIẾU KHÁM BỆNH</title>
  <style>
    body {
      font-family: 'Arial', serif;
      margin: 0;
      padding: 20px;
      font-size: 12pt;
    }
    .header {
      display: flex;
      margin-bottom: 15px;
      align-items: center;
    }
    .clinic-info {
      margin-left: 15px;
    }
    .clinic-name {
      font-size: 18pt;
      font-weight: bold;
    }
    .report-title {
      text-align: center;
      font-size: 20pt;
      margin: 20px 0;
    }
    .patient-info {
      margin-bottom: 15px;
    }
    .info-row {
      display: flex;
      margin-bottom: 8px;
    }
    .info-label {
      width: 120px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .diagnosis {
      padding: 8px;
      margin: 15px 0;
    }
    .doctor-sign {
      margin-top: 50px;
      text-align: right;
    }
    @media print {
      .no-print {
        display: none;
      }
      body {
        padding: 0;
      }
    }
  </style>
</head>
<body>
<div style="text-align: center; font-family: 'Arial', serif; margin-bottom: 20px;">
  <div style="font-size: 16pt; font-weight: bold; margin-bottom: 5px;">
    PHÒNG KHÁM MẮT QUANG HÀ
  </div>
  <div style="font-size: 12pt; margin-bottom: 3px;">
    Địa chỉ: số 171 Lò Đúc, phường Đồng Nhân, quận Hai Bà Trưng, Hà Nội
  </div>
  <div style="font-size: 12pt;">
    Điện thoại: 0917291599 &nbsp;&nbsp;&nbsp; Email: donhuhon@gmail.com
  </div>

  <div style="margin: 15px 0;">
    <hr style="width: 100%; margin: 10px auto; border: 0.5px solid #ccc;">
    <div style="font-size: 18pt; font-weight: bold;">GIẤY KHÁM BỆNH</div>
    <div style="text-align: right; margin-top: 5px; font-size: 12pt;" id="ngaykham">
      Ngày khám: 
    </div>
  </div>
</div>

<div class="patient-info">
  <div class="info-row">
    <div class="info-label">1. Họ và tên:</div>
    <div id="hoten"></div>
  </div>
  <div class="info-row">
    <div class="info-label">2. Năm sinh:</div>
    <div id="namsinh"></div>
    <div style="width: 50px;"></div>
    <div class="info-label">3. Giới tính:</div>
    <div id="gioitinh"></div>
  </div>
  <div class="info-row">
    <div class="info-label">4. Địa chỉ:</div>
    <div id="diachi"></div>
  </div>
  <div class="info-row">
    <div class="info-label">5. Số điện thoại:</div>
    <div id="sdt"></div>
  </div>
  <div class="info-row">
    <div class="info-label">6. Thị lực:</div>
    <div style="width: 50px;">MP:</div>
    <div id="thiluc_mp"></div>
    <div style="width: 50px;"></div>
    <div style="width: 50px;">MT:</div>
    <div id="thiluc_mt"></div>
  </div>
  
  <div class="info-row">
    <div class="info-label">7. Nhãn áp:</div>
    <div style="width: 50px;">MP:</div>
    <div id="nhanap_mp"></div>
    <div style="width: 50px;"></div>
    <div style="width: 50px;">MT:</div>
    <div id="nhanap_mt"></div>
  </div>

  <div class="info-row">
    <div class="info-label">8. CHẨN ĐOÁN:</div>
    <div id="chandoan"></div>
  </div>

  <div style="text-align: center; font-weight: bold; margin: 15px 0;">
    HƯỚNG DẪN ĐIỀU TRỊ
  </div>
  <div class="info-row">
    <div class="info-label">Kính:</div>
    <div id="kinh"></div>
  </div>
  
  <div class="info-label">Đơn thuốc:</div>
  <table id="donthuoc-table">
    <thead>
      <tr>
        <th width="5%">STT</th>
        <th width="30%">Tên thuốc</th>
        <th width="10%">ĐVT</th>
        <th width="10%">Số lượng</th>
        <th width="45%">Cách sử dụng</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="5" style="text-align:center;">Không có đơn thuốc</td>
      </tr>
    </tbody>
  </table>
  
  <div class="info-label">Thủ thuật:</div>
  <table id="thuthuat-table" style="width: 100%; border-collapse: collapse; border-color: rgba(0, 0, 0, 0);">
    <tbody>
      <tr>
        <td colspan="2" style="border: 1px solid rgba(0, 0, 0, 0); padding: 8px; text-align: center; color: black;">
          Không có thủ thuật
        </td>
      </tr>
    </tbody>
  </table>
  
  <div class="info-row">
    <div class="info-label">Khám lại sau:</div>
    <div id="khamlai_sau"></div>
  </div>

  <div class="doctor-sign" style="margin-top: 50px;">
    <div style="text-align: right; padding-right: 50px; margin-bottom: 85px;">BÁC SĨ ĐIỀU TRỊ</div>
    <div style="text-align: right; padding-right: 40px; font-weight: bold;">GS.TS. Đỗ Như Hơn</div>
  </div>

  <button class="no-print" onclick="window.print()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; margin-top: 20px;">In Phiếu</button>
</div>

<script>
  // Hàm lấy tham số từ URL
  function getUrlParameter(name) {
    name = name.replace(/[\[\]]/g, '\\$&');
    const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
    const results = regex.exec(window.location.href);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  // Hàm hiển thị dữ liệu từ URL parameters
  function displayData() {
    // Thông tin cơ bản
    document.getElementById('hoten').textContent = getUrlParameter('hoten') || '';
    document.getElementById('namsinh').textContent = getUrlParameter('namsinh') || '';
    document.getElementById('gioitinh').textContent = getUrlParameter('gioitinh') || '';
    document.getElementById('diachi').textContent = getUrlParameter('diachi') || '';
    document.getElementById('sdt').textContent = getUrlParameter('sdt') || '';
    document.getElementById('ngaykham').textContent += getUrlParameter('ngaykham') || '';
    document.getElementById('thiluc_mp').textContent = getUrlParameter('thiluc_mp') || '';
    document.getElementById('thiluc_mt').textContent = getUrlParameter('thiluc_mt') || '';
    document.getElementById('nhanap_mp').textContent = (getUrlParameter('nhanap_mp') || '') + ' mmHg';
    document.getElementById('nhanap_mt').textContent = (getUrlParameter('nhanap_mt') || '') + ' mmHg';
    document.getElementById('chandoan').textContent = getUrlParameter('chandoan') || '';
    document.getElementById('kinh').textContent = getUrlParameter('kinh') || '';
    document.getElementById('khamlai_sau').textContent = getUrlParameter('khamlai_sau') || '';

    // Xử lý đơn thuốc từ URL (nếu có)
    const donthuocParam = getUrlParameter('donthuoc');
    if (donthuocParam) {
      try {
        const donthuoc = JSON.parse(donthuocParam);
        const tbody = document.querySelector('#donthuoc-table tbody');
        tbody.innerHTML = '';
        
        if (donthuoc.length > 0) {
          donthuoc.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${item.tenThuoc || ''}</td>
              <td>${item.dvt || ''}</td>
              <td>${item.soLuong || ''}</td>
              <td>${item.cachDung || ''}</td>
            `;
            tbody.appendChild(row);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Không có đơn thuốc</td></tr>';
        }
      } catch (e) {
        console.error('Lỗi phân tích đơn thuốc:', e);
      }
    }

    // Xử lý thủ thuật từ URL (nếu có)
    const thuthuatParam = getUrlParameter('thuthuat');
    if (thuthuatParam) {
      try {
        const thuthuat = JSON.parse(thuthuatParam);
        const tbody = document.querySelector('#thuthuat-table tbody');
        tbody.innerHTML = '';
        
        if (thuthuat.length > 0) {
          thuthuat.forEach((item) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td style="border: 1px solid rgba(0, 0, 0, 0); padding: 8px; color: black;">${item.tenThuThu || ''}</td>
              <td style="border: 1px solid rgba(0, 0, 0, 0); padding: 8px; color: black;">${item.ghiChu || ''}</td>
            `;
            tbody.appendChild(row);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="2" style="border: 1px solid rgba(0, 0, 0, 0); padding: 8px; text-align: center; color: black;">Không có thủ thuật</td></tr>';
        }
      } catch (e) {
        console.error('Lỗi phân tích thủ thuật:', e);
      }
    }

    // Tự động in nếu có tham số autoprint=1
    if (getUrlParameter('autoprint') === '1') {
      window.print();
    }
  }

  // Gọi hàm khi trang tải xong
  window.onload = displayData;
</script>
</body>
</html>
